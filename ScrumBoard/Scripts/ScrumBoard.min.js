"use strict";function getQueryStringParameter(n){for(var r=document.URL.split("?")[1].split("&"),i,t=0;t<r.length;t=t+1)if(i=r[t].split("="),i[0]===n)return i[1]}function setupIfNotAlreadyDone(){var i=$.Deferred(),n=SP.ClientContext.get_current(),r=getWeb(n),t=r.get_lists(),u=t.getByTitle(scrumUserListName),f=t.getByTitle(scrumSprintListName),e=t.getByTitle(scrumListName);return n.load(u),n.executeQueryAsync(function(){i.resolve()},function(){var e=new SP.ListCreationInformation,o,r,u,s,f,h;e.set_templateType(SP.ListTemplateType.genericList);e.set_title(scrumUserListName);o=t.add(e);n.load(o);r=o.get_fields();r.addFieldAsXml("<Field Type='Text' DisplayName='Color' Name='Color' />",!0,SP.AddFieldOptions.addToDefaultContentType);n.load(r);u=new SP.ListCreationInformation;u.set_templateType(SP.ListTemplateType.genericList);u.set_title(scrumSprintListName);s=t.add(u);n.load(s);r=s.get_fields();r.addFieldAsXml("<Field Type='DateTime' DisplayName='StartDate' Name='StartDate' Format='DateOnly' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='DateTime' DisplayName='EndDate' Name='EndDate' Format='DateOnly' />",!0,SP.AddFieldOptions.addToDefaultContentType);n.load(r);f=new SP.ListCreationInformation;f.set_templateType(SP.ListTemplateType.genericList);f.set_title(scrumListName);h=t.add(f);n.load(h);r=h.get_fields();r.addFieldAsXml("<Field Type='Note' TextOnly='True' DisplayName='Description' Name='Description' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='Text' DisplayName='Story' Name='Story' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='Text' DisplayName='Status' Name='Status' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='Text' DisplayName='Priority' Name='Priority' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='Text' DisplayName='AssignedTo' Name='AssignedTo' />",!0,SP.AddFieldOptions.addToDefaultContentType);r.addFieldAsXml("<Field Type='Text' DisplayName='Sprint' Name='Sprint' />",!0,SP.AddFieldOptions.addToDefaultContentType);n.load(r);n.executeQueryAsync(function(){i.resolve()},function(){alert("Something went wrong during initial setup. Please delete all existing lists starting with 'ScrumBoard*' and try again.");i.reject()})}),i.promise()}function initAssignedToComboBoxesAndUsers(){var t=$.Deferred(),i=new SP.ClientContext.get_current,r=getWeb(i),u=r.get_lists().getByTitle(scrumUserListName),n=u.getItems(SP.CamlQuery.createAllItemsQuery());return i.load(n),i.executeQueryAsync(function(){var r;for(n.get_count()<1&&$("#newHereHint").show(),r=0;r<n.get_count();r++){var u=n.get_item(r),i=u.get_item("Title"),f=u.get_item("Color");$("#ItemAssignedTo").append('<option value="'+i+'">'+i+"<\/option>");$("#filterByName").append('<option value="'+i+'">'+i+"<\/option>");userColors[i]=f}$("#filterByName").change(function(){var n=$("#filterByName option:selected").val();$(".task").show();n!=="all"&&$(".task[data-assignedTo!='"+n+"']").hide()});t.resolve()},function(){t.reject()}),t.promise()}function initEventHandler(){$(document).on("click",".edit-task",function(){var n=$(this).parent().attr("id"),t=$(this).parent().attr("data-prio"),i=$(this).parent().attr("data-story"),r=$(this).parent().attr("data-sprint"),u=i.replace(/\s/g,""),f=$(this).parent().find(".title .title-inner").text(),e=$(this).parent().find(".assignment").text();$("#modifyItemDialog").dialog("open");$("#modifyItemDialog").attr("data-itemId",n);$("#ItemDesc").val(f);$("#ItemAssignedTo option[value='"+e+"']").attr("selected","selected");$("#ItemStory option[value='"+u+"']").attr("selected","selected");$("#ItemPriority option[value='"+t+"']").attr("selected","selected");$("#ItemSprint option[value='"+r+"']").attr("selected","selected")});$(document).on("click",".delete-task",function(){if(confirm("Delete this task?")){var n=$(this).parent().attr("id");$(this).parent().fadeOut();deleteSPItem(n)}});$(document).on("click",".plus-button",function(){$("#modifyItemDialog").attr("data-itemId","");$("#modifyItemDialog").dialog("open")});$("#newStoryButton").click(function(){$("#newStoryDialog").dialog("open")})}function initEditDialog(){$("#modifyItemDialog").dialog({autoOpen:!1,width:350,height:500,modal:!0,open:function(){$("#ItemStory option").remove();$(".storyBox").each(function(){var n=$(this).attr("data-storyName"),t=n.replace(/\s/g,"");$("#ItemStory").append('<option value="'+t+'">'+n+"<\/option>")});var n=$("#modifyItemDialog").attr("data-itemId");n===""&&$("#ItemDesc").val("")},buttons:{Save:function(){var f=$("#modifyItemDialog").attr("data-itemId"),n=$("#ItemDesc").val(),t=$("#ItemStory option:selected").text(),i=$("#ItemAssignedTo option:selected").val(),r=$("#ItemPriority option:selected").val(),u=$("#ItemSprint option:selected").val();if(n===""||t===""||i===""||r===""||u===""){alert("Please fill in all fields.");return}f===""?addSPItem(t,n,i,r,u,function(f){createTaskItem(t,n,"ToDo",f,r,i,u)}):(updateSPItem(f,t,n,i,r,u),updateTaskItem(f,t,n,i,r,u));$(this).dialog("close")}}})}function initNewStoryDialog(){$("#newStoryDialog").dialog({autoOpen:!1,width:250,height:200,modal:!0,buttons:{Save:function(){var n=$("#NewStoryName").val();createStory(n);$(this).dialog("close")}}})}function initDragDrop(){$(".task").draggable({handle:".handle",revert:"invalid",zIndex:999});$(".dropTarget").droppable({accept:".task",drop:function(n,t){var i=t.draggable,f=i.attr("id"),o=i.attr("data-assignedTo"),r=$(n.target),e=r.attr("data-targetStatus"),u=r.parent("tr").find(".storyBox").attr("data-storyName");i.removeAttr("style");i.appendTo(r);i.attr("data-story",u);updateSPStatus(f,e,u)}})}function initFilterByStory(){$("#filterByStory").change(function(){var t=$("#filterByStory option:selected").val(),n=t.replace(/\s/g,"");$(".storyRow").hide();n!=="all"?$(".storyRow").filter("#"+n+"").show():$(".storyRow").show()})}function initSprintComboBoxes(){var t=new SP.ClientContext.get_current,i=getWeb(t),r=i.get_lists().getByTitle(scrumSprintListName),n=r.getItems(SP.CamlQuery.createAllItemsQuery());t.load(n);t.executeQueryAsync(function(){var t,u;for(n.get_count()<1&&$("#newHereHint").show(),t=0;t<n.get_count();t++){var r=n.get_item(t),i=r.get_item("Title"),f=r.get_item("StartDate"),e=r.get_item("EndDate");$("#ItemSprint").append('<option value="'+i+'">'+i+"<\/option>");$("#filterBySprint").append('<option data-startDate="'+f+'" data-endDate="'+e+'" value="'+i+'">'+i+"<\/option>")}$("#filterBySprint").change(changeSprintFilter);$("#filterBySprint option:eq(1)").attr("selected","selected");u=new Date;$("#filterBySprint option").each(function(){var n=$(this).attr("data-startDate"),t=$(this).attr("data-endDate"),i,r;if(n!==undefined&&t!==undefined&&(i=Date.parseLocale(n,"yyyy-MM-dd HH:mm:ss"),r=Date.parseLocale(t,"yyyy-MM-dd HH:mm:ss"),u>=i&&u<=r))return $(this).attr("selected","selected"),!1})},function(){})}function changeSprintFilter(){var n=$("#filterBySprint option:selected").val();$(".task2").show();n!=="all"&&$(".task2[data-sprint!='"+n+"']").hide()}function createStory(n){var t=n.replace(/\s/g,"");$("#boardTable tbody").append('<tr id="'+t+'" class="storyRow"><td class="story"><div class="storyBox" data-storyName="'+n+'">'+n+'<\/div><\/td><td class="plus"><div class="plus-button" title="Add new task"><img src="../Images/plus.gif" alt="Add new task" /><\/div><\/td><td class="todo dropTarget" data-targetStatus="ToDo"><\/td><td class="inprogress dropTarget" data-targetStatus="InProgress"><\/td><td class="verify dropTarget" data-targetStatus="Verify"><\/td><td class="done dropTarget" data-targetStatus="Done"><\/td><\/tr>');initDragDrop();$("#filterByStory").append('<option value="'+t+'">'+n+"<\/option>")}function createTaskItem(n,t,i,r,u,f,e){var o=n.replace(/\s/g,""),s=userColors[f];u=u.toLowerCase();$("tr#"+o+" td."+i.toLowerCase()).append('<div id="'+r+'" style="display:none;" class="task task2 '+u+'" data-prio="'+u+'" data-story="'+n+'" data-assignedTo="'+f+'" data-sprint="'+e+'"><div class="handle"><\/div><div class="title" title="'+t+'"><pre class="title-inner">'+t+'<\/pre><\/div><div class="assignment" style="background-color: '+s+';">'+f+'<\/div><a href="#" class="delete-task">Löschen<\/a><a href="#" class="edit-task">Edit<\/a><\/div>');$("#"+r).fadeIn();initDragDrop()}function updateTaskItem(n,t,i,r,u,f,e){var o;(e===null||e===undefined||e==="undefined"||e==="")&&(e=$("#"+n).parent("td").attr("data-targetStatus"));var s=$("#"+n).attr("data-story"),h=$("#"+n+" .title-inner").text(),c=$("#"+n).parent("td").attr("data-targetStatus"),l=$("#"+n).attr("data-prio"),a=$("#"+n).attr("data-assignedTo"),v=$("#"+n).attr("data-sprint");(v!==f||s!==t||h.length!==i.length||c!==e||l!==u.toLowerCase()||a!==r)&&($("#"+n).remove(),o=$("#filterBySprint option:selected").val(),(o==="all"||o===f)&&createTaskItem(t,i,e,n,u,r,f))}function getWeb(n){var t=new SP.AppContextSite(n,hostUrl);return t.get_web()}function updateSPStatus(n,t,i){var f=SP.UI.Notify.addNotification("Updating...",!0),u=new SP.ClientContext.get_current,e=getWeb(u),o=e.get_lists().getByTitle(scrumListName),r=o.getItemById(n);u.load(r);r.set_item("Status",t);r.set_item("Story",i);r.update();u.executeQueryAsync(function(){SP.UI.Notify.removeNotification(f)},function(n,t){SP.UI.Notify.removeNotification(f);SP.UI.Notify.addNotification("Fehler! Bitte die Seite neu laden.",!1);var i=SP.UI.Status.addStatus("Fehler : ",t.get_message(),!0);SP.UI.Status.setStatusPriColor(i,"red")})}function updateSPItem(n,t,i,r,u,f){var s=SP.UI.Notify.addNotification("Updating...",!0),o=new SP.ClientContext.get_current,h=getWeb(o),c=h.get_lists().getByTitle(scrumListName),e=c.getItemById(n);o.load(e);e.set_item("Story",t);e.set_item("Description",i);e.set_item("AssignedTo",r);e.set_item("Priority",u);e.set_item("Sprint",f);e.update();o.executeQueryAsync(function(){SP.UI.Notify.removeNotification(s)},function(n,t){SP.UI.Notify.removeNotification(s);SP.UI.Notify.addNotification("Fehler! Bitte die Seite neu laden.",!1);var i=SP.UI.Status.addStatus("Fehler : ",t.get_message(),!0);SP.UI.Status.setStatusPriColor(i,"red")})}function addSPItem(n,t,i,r,u,f){var s=SP.UI.Notify.addNotification("Updating...",!0),o=new SP.ClientContext.get_current,h=getWeb(o),c=h.get_lists().getByTitle(scrumListName),l=new SP.ListItemCreationInformation,e=c.addItem(l);o.load(e);e.set_item("Title",t.substring(0,200));e.set_item("Status","ToDo");e.set_item("Story",n);e.set_item("Description",t);e.set_item("AssignedTo",i);e.set_item("Priority",r);e.set_item("Sprint",u);e.update();o.executeQueryAsync(function(){SP.UI.Notify.removeNotification(s);var n=e.get_id();f(n)},function(n,t){SP.UI.Notify.removeNotification(s);SP.UI.Notify.addNotification("Fehler! Bitte die Seite neu laden.",!1);var i=SP.UI.Status.addStatus("Fehler : ",t.get_message(),!0);SP.UI.Status.setStatusPriColor(i,"red")})}function deleteSPItem(n){var i=SP.UI.Notify.addNotification("Deleting...",!0),t=new SP.ClientContext.get_current,u=getWeb(t),f=u.get_lists().getByTitle(scrumListName),r=f.getItemById(n);t.load(r);r.deleteObject();t.executeQueryAsync(function(){SP.UI.Notify.removeNotification(i)},function(n,t){SP.UI.Notify.removeNotification(i);SP.UI.Notify.addNotification("Fehler! Bitte die Seite neu laden.",!1);var r=SP.UI.Status.addStatus("Fehler : ",t.get_message(),!0);SP.UI.Status.setStatusPriColor(r,"red")})}function pollForChanges(){var n=new SP.ClientContext.get_current,i=getWeb(n),r=i.get_lists().getByTitle(scrumListName),t=r.getItems(SP.CamlQuery.createAllItemsQuery());n.load(t);n.executeQueryAsync(function(){for(var i=0;i<t.get_count();i++){var n=t.get_item(i),u=n.get_item("ID"),r=n.get_item("Story"),f=r.replace(/\s/g,""),e=n.get_item("Status"),o=n.get_item("AssignedTo"),s=n.get_item("Priority"),h=n.get_item("Description"),c=n.get_item("Sprint");$("tr#"+f).length===0&&createStory(r);updateTaskItem(u,r,h,o,s,c,e)}},function(){})}var scrumListName="ScrumBoard",scrumUserListName="ScrumBoardUser",scrumSprintListName="ScrumBoardSprint",userColors={},pollingInterval=5e3,hostUrl="";$(document).ready(function(){hostUrl=decodeURIComponent(getQueryStringParameter("SPHostUrl"));$("#scrumSprintListUrl").attr("href",hostUrl+"/Lists/"+scrumSprintListName);$("#scrumUserListUrl").attr("href",hostUrl+"/Lists/"+scrumUserListName);setupIfNotAlreadyDone().done(function(){initAssignedToComboBoxesAndUsers().done(function(){initSprintComboBoxes();var n=new SP.ClientContext.get_current,i=getWeb(n),r=i.get_lists().getByTitle(scrumListName),t=r.getItems(SP.CamlQuery.createAllItemsQuery());n.load(t);n.executeQueryAsync(function(){for(var i=0;i<t.get_count();i++){var n=t.get_item(i),u=n.get_item("ID"),r=n.get_item("Story"),f=r.replace(/\s/g,""),e=n.get_item("Status"),o=n.get_item("AssignedTo"),s=n.get_item("Priority"),h=n.get_item("Description"),c=n.get_item("Sprint");$("tr#"+f).length===0&&createStory(r);createTaskItem(r,h,e,u,s,o,c)}initEventHandler();initEditDialog();initNewStoryDialog();initDragDrop();initFilterByStory();$(document).tooltip();changeSprintFilter();window.setInterval(pollForChanges,pollingInterval)},function(){})})})});
//# sourceMappingURL=ScrumBoard.min.js.map